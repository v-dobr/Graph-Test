# Platform specific walkthroughs

Try out a sample REST call in our [API Explorer](https://graph.microsoft.io/graph-explorer).

Once you're done exploring the API, come back here and select your favorite platform on the left. We'll guide you through the steps to write a simple application to retrieve emails using the Microsoft Graph.

If your preferred platform isn't listed yet, continue reading this page. We'll go through the same set of steps using raw HTTP requests.

## Getting started with the Microsoft Graph API and REST

The purpose of this guide is to walk through the process of calling the Microsoft Graph to retrieve email messages in Office 365 and Outlook.com. Unlike the platform-specific walkthroughs, this guide focuses on the OAuth and REST requests and responses. It will cover the sequence of requests and responses that an app uses to authenticate and retrieve messages.

## Using OAuth 2.0 to authenticate

In order to call the Microsoft Graph, your app needs an access token from Azure Active Directory (Azure AD). In the following example the app implements the Authorization Code Grant flow to get the access tokens from Azure AD, following standard [OAuth 2.0 protocols](http://tools.ietf.org/html/rfc6749).

### Registering an app

There are currently two options to register your app:

  1. Register an app using the model that supports Office 365 commercial users, work or school accounts only.
 
  This model only works with Office 365 commercial offerings. Once you've registered your app, you can manage it through the [Azure Management Portal](https://manage.windowsazure.com).

  2. Register using the latest functionality that works for both consumer and commercial Office 365 services (we call it Auth endpoint v2.0).
 
  A single authentication service for both work or school and personal accounts is now available. This model provides a single authentication service for both work and school (Azure AD) as well as personal (Microsoft) identities. Now, you only need to implement one authentication flow in your app to enable users to use either work or school accounts, like Office 365 or OneDrive for Business, or personal accounts, like Outlook.com or OneDrive.
   
Use the [Application Registration Portal](https://apps.dev.microsoft.com/) to register your app and support both work and school and personal accounts.

Please note that the v2.0 endpoint is gradually growing to cover all the scenarios from the previous auth endpoint. To choose whether is right for you read [this article](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-limitations/)

After registration, you will get a client ID and secret. These values are used in the Authorization Code Grant flow.

The rest of this document assumes a registration on the v2.0 model. For a complete guide to the flows supported in the v2.0 endpoint see [this article](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-flows/), for a complete guide to the Authorization Code Grant flow see [this article](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-protocols-oauth-code/)

### Getting an authorization code

The first step in the Authorization Code Grant flow is to get an authorization code. That code is returned to the app by the authorization server when the user logs in and consents to the level of access the app requested.

First, the app constructs a logon URL for the user. This URL must be opened in a browser so that the user can log in and provide consent.

The base URL for logon looks like `https://login.microsoftonline.com/common/oauth2/v2.0/authorize`.

The app appends query parameters to this base URL to let the auth server know what app is requesting the logon and what permissions it is requesting.

- `client_id` - The client ID generated by registering the app. This lets Azure AD know which app is requesting the logon.
- `redirect_uri` - The location that Azure will redirect to once the user has granted consent to the app. This value must correspond to the value of **Redirect URI** used when registering the app.
- `response_type` - The type of response the app is expecting. This value is `code` for the Authorization Code Grant flow.
- `scope` - A space-separated list of scopes that the app is requesting. More information in [this article](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-scopes/)
- `state` - A value included in the request that will also be returned in the token response.

For example, the request URL for our application that requires read access to mail would look like the following.

```http
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=<CLIENT ID>&redirect_uri=http%3A%2F%2Flocalhost/myapp%2F&response_type=code&state=1234&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
```

Next, redirect the user to the logon URL. The user will be presented with a sign in screen that displays the name of the app. After they sign in, the user will be presented with a list of the permissions the app requires and asked to allow or deny. Assuming they allow the required access, the browser will be redirected to the redirect URI specified in the initial request with the authorization code in the query string.

```http
http://localhost/myapp/?code=AwABAAAA...cZZ6IgAA&state=1234
```

If you are also using OpenId Connect for Single Sign On, additional parameters are required, see [this article](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-protocols-oidc/) for more information. 

The next step is to exchange the authorization code returned for an access token.

### Getting an access token

To get an access token, the app posts form-encoded parameters to the token request URL (`https://login.microsoftonline.com/common/oauth2/v2.0/token`) with the following parameters.

- `client_id`: The client ID generated by registering the app.
- `client_secret`: The client secret generated by registering the app.
- `code`: The authorization code obtained in the prior step.
- `redirect_uri`: This value must be the same as the value used in the authorization code request.
- `grant_type`: The type of grant the app is using. This value is `code` for the Authorization Code Grant flow.
- `scope` - A space-separated list of scopes that the app is requesting. More information in [this article](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-scopes/)

The request URL for our application, using the code from the previous step, would look like the following.

```http
POST https://login.microsoftonline.com/common/oauth2/v2.0/token
Content-Type: application/x-www-form-urlencoded

{
  grant_type=authorization_code
  &code=AwABAAAA...cZZ6IgAA
  &redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
  &resource=https%3A%2F%2Fgraph.microsoft.com%2F
  &scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
  &client\_id=<CLIENT ID>
  &client\_secret=<CLIENT SECRET>
}
```

The server responds with a JSON payload which includes the access token.

```http
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8

{
  "token_type":"Bearer",
  "expires_in":"3600",
  "access_token":"eyJ0eXAi...b66LoPVA",
  "scope":"https://graph.microsoft.com/mail.read",
  ...
}
```

The access token is found in the `access_token` field of the JSON payload. The app uses this value to set the Authorization header when making REST calls to the API.

## Calling the Microsoft Graph

Once the app has an access token, it's ready to call the Microsoft Graph. Since this sample app is retrieving messages, it will use an HTTP GET request to the `https://graph.microsoft.com/v1.0/me/messages` endpoint.

### Refining the request

Apps can control the behavior of GET requests by using OData query parameters.  It is recommended that apps use these parameters to limit the number of results that are returned and to limit the fields that are returned for each item. 

Our sample app will display messages in a table that shows the subject, sender, and the date and time the message was received. The table displays a maximum of 25 rows and is sorted so that the most recently received message is at the top. The app uses the following query parameters to get these results.

- The `$select` parameter is used to specify only the `subject`, `sender`, and `dateTimeReceived` fields.
- The `$top` parameter is used to specify a maximum of 25 items.
- The `$orderby` parameter is used to sort the results by the `dateTimeReceived` field.

This results in the following request.

```http
GET https://graph.microsoft.com/v1.0/me/messages?$select=subject,from,receivedDateTime&$top=25&$orderby=receivedDateTime%20DESC
Accept: application/json
Authorization: Bearer eyJ0eXAi...b66LoPVA
```

Now that you've seen how to make calls to the Microsoft Graph, you can use the API reference to construct any other kinds of calls your app needs to make. However, bear in mind that your app needs to have the appropriate permissions configured on the app registration for the calls it makes.


